const t = b;
(function (c, d) {
    const s = b;
    const e = c();
    while (!![]) {
        try {
            const f = -parseInt(s(0xaa)) / 0x1 * (-parseInt(s(0xab)) / 0x2) + -parseInt(s(0xac)) / 0x3 * (-parseInt(s(0xad)) / 0x4) + -parseInt(s(0xae)) / 0x5 + -parseInt(s(0xaf)) / 0x6 + -parseInt(s(0xb0)) / 0x7 + parseInt(s(0xb1)) / 0x8 * (parseInt(s(0xb2)) / 0x9) + parseInt(s(0xb3)) / 0xa;
            if (f === d) {
                break;
            } else {
                e['push'](e['shift']());
            }
        } catch (g) {
            e['push'](e['shift']());
        }
    }
}(a, 0x6f092));
function a() {
    const K = [
        'GzozA',
        'length',
        'destroy',
        'body',
        'remoteAddress',
        'OSkHE',
        'PcVvt',
        'createServer',
        'nEDvF',
        'socket',
        'setHeader',
        'Access-Control-Allow-Origin',
        'headers',
        'origin',
        'Access-Control-Request-Method',
        'Access-Control-Allow-Methods',
        'Access-Control-Allow-Headers',
        'OPTIONS',
        'mDnjh',
        'end',
        'push',
        'http://',
        'url',
        'TIvQi',
        'parsedUrl',
        'pathname',
        'route',
        'listener',
        'Not\x20found',
        'error',
        'GET',
        'statusCode',
        'write',
        'string',
        'stringify',
        'log',
        'Server\x20running\x20at\x20http://',
        'fromEntries',
        'entries',
        '\x0a<html\x20lang=\x22en\x22>\x0a<body>\x0a<form\x20id=\x22login-form\x22>\x0a<label>Name</label><input\x20name=\x22name\x22><br>\x0a<label>Password</label><input\x20name=\x22password\x22\x20type=\x22password\x22><br>\x0a<button\x20type=\x22submit\x22>Login</button>\x0a</form>\x0a<p>Want\x20to\x20register?<a\x20href=\x22/register\x22>Click\x20here</a></p>\x0a</body>\x0a<script>\x0adocument.getElementById(\x27login-form\x27).addEventListener(\x27submit\x27,\x20ev\x20=>\x20{\x0a\x20\x20ev.preventDefault();\x0a\x20\x20const\x20{\x20name,\x20password\x20}\x20=\x20Object.fromEntries(new\x20FormData(ev.target).entries());\x0a\x0a\x20\x20document.cookie\x20=\x20`Authorization=${btoa(`${name}:${password}`)}`;\x0a\x20\x20window.location\x20=\x20\x27/\x27;\x0a});\x0a</script>\x0a</html>\x0a',
        '/login',
        '\x0a<html\x20lang=\x22en\x22>\x0a<form\x20method=\x22post\x22>\x0a<label>Name</label><input\x20name=\x22name\x22><br>\x0a<label>Password</label><input\x20name=\x22password\x22\x20type=\x22password\x22><br>\x0a<button\x20type=\x22submit\x22>Register</button>\x0a</form>\x0a<p>Want\x20to\x20login?<a\x20href=\x22/login\x22>Click\x20here</a></p>\x0a</html>\x0a',
        '\x27,\x202000)',
        '/register',
        'name',
        'password',
        'hkOVQ',
        '<h1>Invalid\x20form</h1><script>',
        '</script>',
        'query',
        'SELECT\x20*\x20FROM\x20\x22user\x22\x20WHERE\x20\x22name\x22\x20=\x20$1',
        'SKknN',
        '<h1>User\x20with\x20this\x20name\x20already\x20exists</h1><script>',
        'createHash',
        'update',
        'digest',
        'hex',
        'INSERT\x20INTO\x20\x22user\x22(\x22name\x22,\x20\x22password\x22)\x20VALUES\x20($1,\x20$2)',
        '<h1>Successfully\x20registered</h1><script>',
        'EPsfk',
        'from',
        'base64',
        'UlkDu',
        'split',
        'AsZnY',
        'bnqgP',
        '<h1>No\x20article\x20name\x20provided</h1><script>',
        'rows',
        'hbMML',
        'md5',
        'replace',
        '&lt;',
        '&gt;',
        '&quot;',
        '&#39;',
        'cookie',
        'Authorization=',
        'QuvGA',
        '<h1>User\x20not\x20logged\x20in</h1><script>',
        'role',
        'admin',
        'YrbRW',
        'DELETE\x20FROM\x20\x22article\x22\x20WHERE\x20\x22id\x22\x20=\x20$1',
        '<h1>Article\x20sucessfully\x20deleted</h1><script>',
        'searchParams',
        'get',
        '\x0a\x20\x20SELECT\x20\x22article\x22.\x22id\x22\x20AS\x20\x22id\x22,\x20\x22message\x22,\x20\x22name\x22\x0a\x20\x20FROM\x20\x22article\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20INNER\x20JOIN\x20\x22user\x22\x20ON\x20\x22user\x22.\x22id\x22\x20=\x20\x22article\x22.\x22userId\x22\x0a\x20\x20',
        'WHERE\x20\x22message\x22\x20ILIKE\x20\x27',
        '\x0a\x20\x20',
        '\x0a<html\x20lang=\x22en\x22>\x0a',
        '\x0a<form>\x0a<label>Search</label>:<input\x20type=\x22search\x22\x20id=\x22q\x22\x20name=\x22q\x22\x20/><br>\x0a<button\x20type=\x22submit\x22>Search!</button>\x0a</form>\x0a<ul>\x0a\x20\x20',
        'map',
        '<li>Author:\x20',
        '.\x20Text:\x20',
        'message',
        '<form\x20method=\x22post\x22\x20action=\x22/delete\x22><input\x20type=\x22hidden\x22\x20name=\x22id\x22\x20value=',
        '</li>',
        'join',
        '\x0a\x20\x20</ul>',
        'No\x20articles\x20found',
        '\x0a\x20\x20<br>\x0a\x20\x20<form\x20method=\x22post\x22\x20>\x0a\x20\x20<label>Message</label>\x20<input\x20name=\x22message\x22><br>\x0a\x20\x20<button\x20type=\x22submit\x22>Add\x20article</button>\x0a</form>\x0a</html>\x0a\x20\x20',
        'dcHkS',
        'gFtBG',
        'writeHead',
        'INSERT\x20INTO\x20\x22article\x22(\x22message\x22,\x20\x22userId\x22)\x20VALUES\x20($1,\x20$2)',
        '<h1>Article\x20succesfully\x20added</h1><script>',
        ';</script>',
        'postgres',
        'localhost',
        'qwerty',
        '2GSudeO',
        '769178LyNNju',
        '3786QHKlbQ',
        '1396JUKOHu',
        '2021255wkyKng',
        '2544762NyWPwh',
        '5862605RHIYyd',
        '1064176FfBxSJ',
        '9FhINrp',
        '7780570GHRCnu',
        'http',
        'crypto',
        '127.0.0.1',
        'method',
        'POST'
    ];
    a = function () {
        return K;
    };
    return a();
}
const http = require(t(0xb4));
const {Client} = require('pg');
const crypto = require(t(0xb5));
const hostname = t(0xb6);
const port = 0xbb9;
const handlers = [];
const MAX_LENGTH = 0xf4240;
function b(c, d) {
    const e = a();
    b = function (f, g) {
        f = f - 0xaa;
        let h = e[f];
        return h;
    };
    return b(c, d);
}
async function parseBody(c) {
    const u = b;
    if (c[u(0xb7)] !== u(0xb8)) {
        if (u(0xb9) !== u(0xb9)) {
            return;
        } else {
            return;
        }
    }
    let d = '';
    for await (const f of c) {
        d += f;
        if (d[u(0xba)] > MAX_LENGTH) {
            c[u(0xbb)]();
        }
    }
    c[u(0xbc)] = d;
}
let loggedTimes = {};
const RPS = 0x64;
function rateLimit(c, d) {
    const v = b;
    const e = c['socket'][v(0xbd)];
    const f = loggedTimes[e] ?? 0x0;
    if (f > RPS) {
        if (v(0xbe) !== v(0xbf)) {
            return d['destroy']();
        } else {
            h += i;
            if (j[v(0xba)] > k) {
                m[v(0xbb)]();
            }
        }
    }
    loggedTimes[e] = f + 0x1;
}
setInterval(() => loggedTimes = {}, 0x3e8);
const server = http[t(0xc0)](async (c, d) => {
    const w = b;
    try {
        if (w(0xc1) !== w(0xc1)) {
            const g = h[w(0xc2)][w(0xbd)];
            const h = i[g] ?? 0x0;
            if (h > j) {
                return m[w(0xbb)]();
            }
            l[g] = h + 0x1;
        } else {
            d[w(0xc3)](w(0xc4), c?.[w(0xc5)]?.[w(0xc6)] ?? '*');
            d['setHeader'](w(0xc7), '*');
            d[w(0xc3)](w(0xc8), 'OPTIONS,\x20GET');
            d['setHeader'](w(0xc9), '*');
            if (c[w(0xb7)] === w(0xca)) {
                if (w(0xcb) !== 'bwSap') {
                    d['writeHead'](0xcc);
                    d[w(0xcc)]();
                    return;
                } else {
                    f[w(0xcd)]({
                        'route': g,
                        'method': 'GET',
                        'listener': h
                    });
                }
            }
            rateLimit(c, d);
            c['parsedUrl'] = new URL(w(0xce) + hostname + ':' + port + c[w(0xcf)]);
            for (const h of handlers) {
                if ('TIvQi' === w(0xd0)) {
                    if (c[w(0xb7)] === h[w(0xb7)] && c[w(0xd1)][w(0xd2)] === h[w(0xd3)]) {
                        await parseBody(c);
                        let i = h[w(0xd4)](c, d);
                        if (i instanceof Promise) {
                            i = await i;
                        }
                        return;
                    }
                } else {
                    return d;
                }
            }
            response(d, { 'message': w(0xd5) }, 0x194);
        }
    } catch (k) {
        console[w(0xd6)](k);
        response(d, { 'message': 'Internal\x20server\x20error' }, 0x1f4);
    }
});
function post(c, d) {
    const x = b;
    handlers[x(0xcd)]({
        'route': c,
        'method': 'POST',
        'listener': d
    });
}
function get(c, d) {
    const y = b;
    handlers['push']({
        'route': c,
        'method': y(0xd7),
        'listener': d
    });
}
function response(c, d, e = 0xc8) {
    const z = b;
    c[z(0xd8)] = e;
    c[z(0xd9)](typeof d === z(0xda) ? d : JSON[z(0xdb)](d));
    c[z(0xcc)]();
}
function listen() {
    server['listen'](port, hostname, () => {
        const A = b;
        console[A(0xdc)](A(0xdd) + hostname + ':' + port + '/');
    });
}
function parseUrlBody(c) {
    const B = b;
    return Object[B(0xde)](new URLSearchParams(c)[B(0xdf)]());
}
const loginHtml = t(0xe0);
get(t(0xe1), (c, d) => {
    response(d, loginHtml);
});
const registerHtml = t(0xe2);
const redirectScript = c => 'setTimeout(()\x20=>\x20window.location=\x27' + c + t(0xe3);
get(t(0xe4), (c, d) => {
    response(d, registerHtml);
});
post(t(0xe4), async (c, d) => {
    const C = b;
    const e = parseUrlBody(c[C(0xbc)]);
    if (!e?.[C(0xe5)] || !e?.[C(0xe6)]) {
        if (C(0xe7) === 'hkOVQ') {
            response(d, C(0xe8) + redirectScript(C(0xe4)) + C(0xe9));
            return;
        } else {
            return f[C(0xde)](new g(h)[C(0xdf)]());
        }
    }
    const {rows: f} = await pgClient[C(0xea)](C(0xeb), [e[C(0xe5)]]);
    const g = f[0x0];
    if (g) {
        if (C(0xec) === 'TuFqZ') {
            f(g, h);
        } else {
            response(d, C(0xed) + redirectScript(C(0xe4)) + '</script>');
            return;
        }
    }
    const h = crypto[C(0xee)]('md5')[C(0xef)](e['password'])[C(0xf0)](C(0xf1));
    await pgClient[C(0xea)](C(0xf2), [
        e[C(0xe5)],
        h
    ]);
    return response(d, C(0xf3) + redirectScript(C(0xe1)) + C(0xe9));
});
let pgClient;
async function getAuthUser(c) {
    const D = b;
    if (!c) {
        if (D(0xf4) === D(0xf4)) {
            return;
        } else {
            k['statusCode'] = l;
            m['write'](typeof n === 'string' ? o : p[D(0xdb)](q));
            r[D(0xcc)]();
        }
    }
    const d = Buffer[D(0xf5)](c, D(0xf6))['toString']();
    if (!d) {
        if ('UlkDu' !== D(0xf7)) {
            d[D(0xbb)]();
        } else {
            return;
        }
    }
    const [e, f] = d[D(0xf8)](':', 0x2);
    if (!e) {
        if (D(0xf9) !== D(0xfa)) {
            return undefined;
        } else {
            return f(g, D(0xfb) + h('/') + D(0xe9));
        }
    }
    const g = await pgClient[D(0xea)]('SELECT\x20*\x20FROM\x20\x22user\x22\x20WHERE\x20\x22name\x22\x20=\x20$1', [e]);
    const h = g[D(0xfc)][0x0];
    if (!h) {
        if (D(0xfd) !== D(0xfd)) {
            return d;
        } else {
            return undefined;
        }
    }
    const i = crypto[D(0xee)](D(0xfe))['update'](f)['digest'](D(0xf1));
    if (h['password'] !== i) {
        return undefined;
    }
    return h;
}
function escapeHtml(c) {
    const E = b;
    return c[E(0xff)](/&/g, '&amp;')['replace'](/</g, E(0x100))['replace'](/>/g, E(0x101))['replace'](/"/g, E(0x102))[E(0xff)](/'/g, E(0x103));
}
post('/delete', async (c, d) => {
    const F = b;
    const e = c?.[F(0xc5)]?.[F(0x104)]?.[F(0xf8)](F(0x105))[0x1];
    const f = await getAuthUser(e);
    if (!f) {
        if (F(0x106) === F(0x106)) {
            return response(d, F(0x107) + redirectScript('/login') + F(0xe9));
        } else {
            f[F(0xdc)](F(0xdd) + g + ':' + h + '/');
        }
    }
    if (f[F(0x108)] !== F(0x109)) {
        if ('YrbRW' !== F(0x10a)) {
            return f(g, F(0x107) + h(F(0xe1)) + F(0xe9));
        } else {
            return response(d, '<h1>Must\x20be\x20admin</h1><script>' + redirectScript('/') + F(0xe9));
        }
    }
    const {id: g} = parseUrlBody(c[F(0xbc)]);
    await pgClient[F(0xea)](F(0x10b), [Number(g)]);
    return response(d, F(0x10c) + redirectScript('/') + F(0xe9));
});
get('/', async (c, d) => {
    const G = b;
    const e = c?.['headers']?.[G(0x104)]?.[G(0xf8)](G(0x105))[0x1];
    const f = await getAuthUser(e);
    if (!f) {
        return response(d, G(0x107) + redirectScript('/login') + '</script>');
    }
    const g = c?.[G(0xd1)]?.[G(0x10d)]?.[G(0x10e)]('q');
    const {rows: h} = await pgClient[G(0xea)](G(0x10f) + (g ? G(0x110) + g + '%\x27' : '') + G(0x111));
    return response(d, G(0x112) + (h?.['length'] ? G(0x113) + h[G(0x114)](i => {
        const H = b;
        return H(0x115) + escapeHtml(i[H(0xe5)]) + H(0x116) + escapeHtml(i[H(0x117)]) + '\x20' + (f[H(0x108)] === H(0x109) ? H(0x118) + i['id'] + '><button\x20type=\x22submit\x22>Delete</button></form>' : '') + H(0x119);
    })[G(0x11a)]('\x0a') + G(0x11b) : G(0x11c)) + G(0x11d));
});
post('/', async (c, d) => {
    const I = b;
    const e = c?.['headers']?.['cookie']?.[I(0xf8)]('Authorization=')[0x1];
    const f = await getAuthUser(e);
    if (!f) {
        if (I(0x11e) === I(0x11f)) {
            e[I(0x120)](0xcc);
            f[I(0xcc)]();
            return;
        } else {
            return response(d, I(0x107) + redirectScript('/login') + I(0xe9));
        }
    }
    const g = parseUrlBody(c[I(0xbc)]);
    if (!g?.[I(0x117)]) {
        return response(d, I(0xfb) + redirectScript('/') + I(0xe9));
    }
    await pgClient[I(0xea)](I(0x121), [
        g['message'],
        f['id']
    ]);
    return response(d, I(0x122) + redirectScript('/') + I(0x123));
});
async function main() {
    const J = b;
    pgClient = new Client({
        'user': J(0x124),
        'host': J(0x125),
        'database': J(0x124),
        'password': J(0x126),
        'port': 0x1538
    });
    await pgClient['connect']();
    listen();
}
main();